# 基础



## 什么是索引？

就像一本字典，如果没有目录，那我们需要从头到尾全查，而索引就像目录，我们可以按照拼音或者笔画进行排序，通过拼音笔画快速找到要查询的内容。索引根据一个记录中的一个/多个/部分字段进行排序存储起来，使用这些字段进行查找就会快很多。

In short，索引是一个排好序的数据结构，用来提高搜索效率



**缺点**

* 由于增删改时需要维护索引，所以会降低增删改的效率。
* 索引文件也是需要存储的，会占用一些磁盘(不是问题)。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  



## 索引的数据结构



**B树与B+树**

B树中每个节点都包含索引值和Data，所以Data比较大时，每个节点能保存的key比较少，导致树的高度增加，IO次数变多。

B+树非叶子节点只保存索引值，所有Data都是按照键值的大小存放在叶子节点上，

* 这样每个节点可以多保存的Key，降低树的高度，减少IO次数，
* 同时所有Data都按照索引值的大小放在叶子节点，对范围查询也更方便
* 所有的查询都要到叶子节点，查询速度相对稳定
* 全表扫描时，B+树只需要扫描叶子节点，B树要一层一层扫描



数据页时MySQL数据存储的最小单位，数据之间通过单链表关联，数据页之间通过双链表关联，数据页的默认大小是16kb

MySQL的数据页类型有十多种，包括：索引页，Undo页，Inode页，系统页，Blob页等

索引页：索引页中记录的是每页数据页的页号和该数据页中最小的主键的记录。

索引页的索引页：索引页太多了，向上分裂出一个索引索引页的索引页，先索引出索引页，再索引出数据页。不够时继续往上分裂



## **索引的分类**



按照物理存储，分为聚簇索引和和非聚簇索引，我们也把非聚集 索引称为二级索引或者辅助索引。

**聚簇索引：**按照主键进行排序，数据页存储的是整个记录，每个InnoDB表都有一个聚簇索引

**非聚簇索引**：按照指定的字段进行排序，相等时按照主键去排序，数据页只存储索引的字段和主键，因为相同的数据只再聚簇索引存一份就好了，找到了主键再去聚簇索引中拿。

通过非聚簇索引进行查找，聚簇索引的数据页只保存索引的字段和主键，当还需要其他字段时，就需要通过主键去到聚簇索引中取，这种情况就叫做**回表**。而如果select的字段恰好就是索引的字段就不需要进行回表查询，这种情况就叫做**索引覆盖**(索引的字段已经覆盖到select的字段了)

**索引下推**

查询条件有多个，按照一个索引进行搜索，有两种做法

1. 筛选出满足这个索引的记录，然后读取到server根据其他条件按再进行筛选
2. 将筛选的操作下推到存储引擎，根据一个索引筛选后会判断where中还有没有其他索引可以继续筛选，这样就可能会减少查询的次数和回表的次数。



* 普通索引
* 唯一索引
* 主键索引
* 组合索引



**Hash索引**

单条记录的查询，时间复杂度是O(1)，但只适合精确查找，不适合模糊和范围查找



# 索引的创建





## 创建索引



1. 创建表的时候指定索引

```mysql
CREATE TABLE table_name [col_name data_type]
[UNIQUE | FULLTEXT | SPATIAL] [INDEX | KEY] [index_name] (col_name [length]) [ASC |
DESC]
```

举例

```mysql
CREATE TABLE test1(
id INT NOT NULL,
name varchar(30) NOT NULL,
UNIQUE INDEX uk_idx_id(id)
);
```



2. 已存在的表上添加索引

```mysql
ALTER TABLE table_name ADD [UNIQUE | FULLTEXT | SPATIAL] [INDEX | KEY]
[index_name] (col_name[length],...) [ASC | DESC]
```

或者

```mysql
CREATE [UNIQUE | FULLTEXT | SPATIAL] INDEX index_name
ON table_name (col_name[length],...) [ASC | DESC]
```





## 删除索引



```mysql
DROP INDEX index_name ON table_name;
```

或者

```mysql
ALTER TABLE table_name DROP INDEX index_name;
```





## **创建索引的原则**



**哪些情况适合建索引**

* 频繁作为WHERE，GroupBy，OrderBy条件的
* 数值有唯一性的或区分度高的



**数据页**

找到数据所在的列

数据页模型：存放着一行行数据(行格式)及一些额外的信息(如最大值和最小值，下一页的地址等)

行格式除了记录每列的数据外，也记录了一些额外的信息：如下一行的地址









**目录页**

索引目录也需要存储在页中



**索引的数据结构**

B+树

B+树是逻辑结构，不是物理结构

每个节点记录key值和数据页的地址？快速找到所在的数据页，减少磁盘IO操作

数据页作为B+树的叶子节点，目录页作为非叶子节点

* 根节点的位置不变，开始存放数据页，随着数据的增多，变为目录页



**聚簇索引**

根据主键构建的索引称为聚簇索引。**聚簇索引不是一种索引类型**，而是一种数据存储方式。InnoDB中存在。InnoDB会自动创建索引，即使我们没有定义主键(InnoDB会隐式定义一列)

B+树的节点中存的是索引值(一般是主键)，叶子节点存储着所有数据。

普通索引的叶子节点存的是PK值(一般是主键)



**非聚簇索引**

非聚簇索引可以有多个。非聚簇索引叶子节点存放的是主键的key，如果需要获得数据页，还需要再去聚簇索引中查找，这就叫回表。所以非聚簇索引的查询效率可能比聚簇索引底，但是增删改的效率要比局促索引高。



**联合索引的数据结构**

因为排序规则是按照联合索引定义的顺序进行的



**查看当前表中的索引**

```mysql
show index from table_name
```



**查看索引**

```mysql
show index from 表名
```



# 数据的存储结构



# 索引的数据结构



# 索引创建的原则



# **MySQL8索引新特性**



**降序索引**



**隐藏索引**



# 名词

数据页，页目录





